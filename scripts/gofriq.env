#!/bin/bash
# Centralized GOFR-IQ Configuration
# Source this file in all scripts and tests:
#   source "$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)/gofriq.env"
#
# Environment Modes:
#   GOFR_IQ_ENV=PROD  => uses $GOFR_IQ_ROOT/data
#   GOFR_IQ_ENV=TEST  => uses $GOFR_IQ_ROOT/test/data (default)
#
# All ports and hosts can be overridden via environment variables before sourcing.

# Determine GOFR_IQ_ROOT - the project root directory
if [ -z "${GOFR_IQ_ROOT:-}" ]; then
    # Try to get from BASH_SOURCE first (when directly sourced)
    if [ -n "${BASH_SOURCE[0]:-}" ] 2>/dev/null; then
        GOFR_IQ_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"
    elif [ -n "${PROJECT_ROOT:-}" ]; then
        # Use PROJECT_ROOT if set by caller (run_tests.sh sets this)
        GOFR_IQ_ROOT="${PROJECT_ROOT}"
    else
        # Fallback to current directory
        GOFR_IQ_ROOT="$(cd "." && pwd)"
    fi
fi

# Set environment mode (PROD or TEST)
export GOFR_IQ_ENV="${GOFR_IQ_ENV:-TEST}"

# Core directories
export GOFR_IQ_ROOT
export GOFR_IQ_LOGS="${GOFR_IQ_ROOT}/logs"

# Select data directory based on environment
if [ "$GOFR_IQ_ENV" = "PROD" ]; then
    export GOFR_IQ_DATA="${GOFR_IQ_ROOT}/data"
else
    export GOFR_IQ_DATA="${GOFR_IQ_ROOT}/test/data"
fi

# Data subdirectories (based on GOFR_IQ_ENV)
export GOFR_IQ_STORAGE="${GOFR_IQ_DATA}/storage"

# Token store (legacy - file backend, kept for backwards compatibility)
export GOFR_IQ_TOKEN_STORE="${GOFR_IQ_LOGS}/gofriq_tokens.json"

# =============================================================================
# Auth Backend Configuration (Vault)
# =============================================================================
# Backend selection: vault (default), file, memory
export GOFR_AUTH_BACKEND="${GOFR_AUTH_BACKEND:-vault}"

# Vault server configuration
export GOFR_VAULT_URL="${GOFR_VAULT_URL:-http://gofr-vault:8200}"
export GOFR_VAULT_PORT="${GOFR_VAULT_PORT:-8201}"
export GOFR_VAULT_DEV_TOKEN="${GOFR_VAULT_DEV_TOKEN:-gofr-dev-root-token}"
export GOFR_VAULT_TOKEN="${GOFR_VAULT_TOKEN:-${GOFR_VAULT_DEV_TOKEN}}"
export GOFR_VAULT_PATH_PREFIX="${GOFR_VAULT_PATH_PREFIX:-gofr-iq/auth}"
export GOFR_VAULT_MOUNT_POINT="${GOFR_VAULT_MOUNT_POINT:-secret}"

# Production AppRole (set these in production, leave empty for dev)
export GOFR_VAULT_ROLE_ID="${GOFR_VAULT_ROLE_ID:-}"
export GOFR_VAULT_SECRET_ID="${GOFR_VAULT_SECRET_ID:-}"

# Create required directories if they don't exist
mkdir -p "$GOFR_IQ_LOGS"
mkdir -p "$GOFR_IQ_STORAGE"

# =============================================================================
# Network Configuration
# =============================================================================
export GOFR_IQ_HOST="${GOFR_IQ_HOST:-0.0.0.0}"
export GOFR_IQ_DOCKER_NETWORK="${GOFR_IQ_DOCKER_NETWORK:-gofr-net}"

# =============================================================================
# LLM Configuration (OpenRouter)
# =============================================================================
# Set your OpenRouter API key here or via environment variable
export GOFR_IQ_OPENROUTER_API_KEY="${GOFR_IQ_OPENROUTER_API_KEY:-}"

# =============================================================================
# Server Ports (all configurable via environment)
# =============================================================================
# Port configuration - using centralized gofr-common port allocation
# gofr-iq: MCP=8080, MCPO=8081, Web=8082
export GOFR_IQ_MCP_PORT="${GOFR_IQ_MCP_PORT:-8080}"
export GOFR_IQ_MCPO_PORT="${GOFR_IQ_MCPO_PORT:-8081}"
export GOFR_IQ_WEB_PORT="${GOFR_IQ_WEB_PORT:-8082}"
export GOFR_IQ_WEBUI_PORT="${GOFR_IQ_WEBUI_PORT:-9095}"
