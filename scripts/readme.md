# Key Management & Scripts

This directory contains utility scripts for managing the GOFR-IQ environment, with a primary focus on **Key Management** and **Authentication Bootstrap**.

## üîë Key Management (bootstrap.py)

The `bootstrap.py` script is the central authority for initializing security. It manages the lifecycle of:
1.  **Vault Initialization**: Unsealing keys and Root tokens.
2.  **JWT Signing Secret**: Used to sign all auth tokens.
3.  **Bootstrap Tokens**: Long-lived (365 day) tokens for Admin and Public access.

### Usage

```bash
# First Run (Auto-initializes Vault)
uv run bootstrap.py --auto-init

# Restarting (Using existing credentials)
source ../docker/.vault-init.env
uv run bootstrap.py

# Key Rotation (Invalidates old tokens)
source ../docker/.vault-init.env
uv run bootstrap.py --rotate-tokens
```

### Where are Secrets Stored?

| Secret | Storage Location | Persistence |
|--------|------------------|-------------|
| **Vault Root Token** | `docker/.vault-init.env` | Critical, do not lose. |
| **Vault Unseal Key** | `docker/.vault-init.env` | Critical, needed after restart. |
| **JWT Signing Secret**| Vault (`secret/gofr/config/jwt-signing-secret`) | Persistent in Vault data volume. |
| **Admin Token** | Vault (`secret/gofr/config/bootstrap-tokens/admin-token-id`) | Persistent in Vault data volume. |
| **Service Secrets** | `docker/.env` | Generated by bootstrap for containers. |

### üö® Recovery

**If you lose `docker/.vault-init.env`:**
You cannot unseal Vault or authenticate as root. You must:
1.  Delete the Vault volume (`docker volume rm gofr-vault-data`).
2.  Run `bootstrap.py --auto-init` to generate new keys.
3.  **Warning**: All previous data/tokens will be lost.

---

## üõ†Ô∏è Helper Scripts (common tasks)

| Need to‚Ä¶ | Run |
|----------|-----|
| Fresh prod start | `./docker/start-prod.sh --fresh --openrouter-key <key>` |
| Restart prod stack | `./docker/start-prod.sh` |
| Rotate bootstrap tokens | `source docker/.vault-init.env && uv run scripts/bootstrap.py --rotate-tokens` |
| Start dev infra (Neo4j/Chroma) | `cd docker && ./run-dev.sh` |
| Run tests | `./scripts/run_tests.sh [--refresh-env]` |
| Manage sources | `./scripts/manage_source.sh` |

> Pass `--refresh-env` when you need to regenerate `docker/.env` and `config/generated/secrets.env` (first run, onboarding a new machine, or after Vault credentials change).

## üìù Environment Templates

*   **`gofriq.env.example`**: Template for your local `.env`. Copy to `gofriq.env` and populate with your API keys (like OpenRouter). Never commit `gofriq.env`.
