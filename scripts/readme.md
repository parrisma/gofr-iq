# Key Management & Scripts

This directory contains utility scripts for managing the GOFR-IQ environment, with a primary focus on **Key Management** and **Authentication Bootstrap**.

## üîë Key Management (bootstrap.py)

The `bootstrap.py` script is the central authority for initializing security. It manages the lifecycle of:
1.  **Vault Initialization**: Unsealing keys and Root tokens.
2.  **JWT Signing Secret**: Used to sign all auth tokens.
3.  **Bootstrap Tokens**: Long-lived (365 day) tokens for Admin and Public access.

### Usage

```bash
# First Run (Auto-initializes Vault)
uv run bootstrap.py --auto-init

# Restarting (Using existing credentials from secrets/)
uv run bootstrap.py

# Key Rotation (Invalidates old tokens)
uv run bootstrap.py --rotate-tokens
```

### Where are Secrets Stored?

| Secret | Storage Location | Persistence |
|--------|------------------|-------------|
| **Vault Root Token** | `secrets/vault_root_token` | Critical, do not lose. |
| **Vault Unseal Key** | `secrets/vault_unseal_key` | Critical, needed after restart. |
| **JWT Signing Secret**| Vault (`secret/gofr/config/jwt-signing-secret`) | Persistent in Vault data volume. |
| **Admin Token** | Vault (`secret/gofr/config/bootstrap-tokens/admin-token-id`) | Persistent in Vault data volume. |
| **Service Secrets** | `docker/.env` | Generated by bootstrap for containers. |
| **AppRole Credentials** | `secrets/service_creds/` | Per-service identity (Zero-Trust). |

### üö® Recovery

**If you lose `secrets/` directory:**
You cannot unseal Vault or authenticate as root. You must:
1.  Delete the Vault volume (`docker volume rm gofr-vault-data`).
2.  Run `bootstrap.py --auto-init` to generate new keys.
3.  **Warning**: All previous data/tokens will be lost.

---

## üõ†Ô∏è All Scripts (Quick Reference)

| Script | Purpose | Command |
|--------|---------|---------|
| **bootstrap.py** | Initialize Vault & create tokens | `uv run scripts/bootstrap.py --auto-init` |
| **start-prod.sh** | Start full production stack | `./docker/start-prod.sh --fresh --openrouter-key <key>` |
| **run_tests.sh** | Run unit/integration tests | `./scripts/run_tests.sh --mode all` |
| **dump_environment.sh** | Show full system status & health | `./scripts/dump_environment.sh --docker` |
| **manage_source.sh** | Manage data sources | `./scripts/manage_source.sh list --docker --token <token>` |
| **manage_document.sh** | Query documents, get stats | `./scripts/manage_document.sh stats --docker --token <token>` |
| **setup_approle.py** | Configure AppRole (Zero-Trust) | `uv run scripts/setup_approle.py` |

---

### Environment & Status Checks

**See everything at once:**
```bash
./scripts/dump_environment.sh --docker
```

Shows: Services running, ports, connection strings, configs, auth tokens, data stats, health checks.

---

## üìù Environment Templates

*   **`gofriq.env.example`**: Template for your local `.env`. Copy to `gofriq.env` and populate with your API keys (like OpenRouter). Never commit `gofriq.env`.
