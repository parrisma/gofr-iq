# GOFR-IQ Docker Compose - Test Stack (Ephemeral)
#
# Port Configuration:
#   All ports defined in lib/gofr-common/config/gofr_ports.env
#   Test ports are production ports + 100 (calculated by scripts/run_tests.sh)
#   Managed via docker/manage-infra.sh which handles test port offsets
#
# Usage:
#   # Ports are automatically configured by manage-infra.sh when run in test mode
#   docker/manage-infra.sh start --test           # Start test infrastructure
#   docker/manage-infra.sh stop                   # Stop test infrastructure
#   # Or use the test runner:
#   ./scripts/run_tests.sh                        # Handles all infrastructure setup
#
# Services (Ephemeral - no persistent volumes):
#   - vault:    HashiCorp Vault (Auth backend) - port ${GOFR_VAULT_PORT} (8301)
#   - neo4j:    Graph Database - ports ${GOFR_NEO4J_HTTP_PORT}, ${GOFR_NEO4J_BOLT_PORT} (7574, 7787)
#   - chromadb: Vector Database - port ${GOFR_CHROMA_PORT} (8100)
#   - mcp:      MCP Server (Core Logic) - port ${GOFR_IQ_MCP_PORT} (8180)
#   - mcpo:     MCPO Server (OpenAPI) - port ${GOFR_IQ_MCPO_PORT} (8181)
#   - web:      Web Server (Health Check) - port ${GOFR_IQ_WEB_PORT} (8182)

name: gofr-iq-test

x-gofr-ports: &gofr_ports
  env_file:
    - ../lib/gofr-common/config/gofr_ports.env

services:
  # ==========================================================================
  # INFRASTRUCTURE (Ephemeral - Test Mode)
  # ==========================================================================

  # HashiCorp Vault - Auth Backend (Dev Mode - ephemeral)
  vault:
    <<: *gofr_ports
    image: gofr-iq-vault:latest
    container_name: gofr-vault-test
    hostname: gofr-vault-test
    restart: "no"
    cap_add:
      - IPC_LOCK
    ports:
      - "${GOFR_VAULT_PORT}:8200"
    environment:
      - VAULT_DEV_ROOT_TOKEN_ID=${GOFR_VAULT_DEV_TOKEN}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:8200
      - VAULT_ADDR=http://127.0.0.1:8200
      - VAULT_TOKEN=${GOFR_VAULT_DEV_TOKEN}
      - GOFR_JWT_SECRET=${GOFR_JWT_SECRET}
    entrypoint: /bin/sh
    command: 
      - -c
      - |
        # Start Vault in background
        vault server -dev -dev-root-token-id=$${VAULT_DEV_ROOT_TOKEN_ID} -dev-listen-address=$${VAULT_DEV_LISTEN_ADDRESS} &
        VAULT_PID=$$!
        # Wait for Vault to be ready
        for i in 1 2 3 4 5 6 7 8 9 10; do
          if vault status >/dev/null 2>&1; then
            break
          fi
          sleep 1
        done
        # Initialize JWT secret for test MCP
        echo "Initializing test Vault with JWT secret..."
        vault kv put secret/gofr/config/jwt-signing-secret value="$${GOFR_JWT_SECRET}" 2>/dev/null || true
        echo "Test Vault initialized"
        # Wait for Vault process
        wait $$VAULT_PID
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    # No volumes - ephemeral

  neo4j:
    <<: *gofr_ports
    image: gofr-iq-neo4j:latest
    container_name: gofr-iq-neo4j-test
    hostname: gofr-iq-neo4j-test
    restart: "no"
    ports:
      - "${GOFR_NEO4J_HTTP_PORT}:7474"
      - "${GOFR_NEO4J_BOLT_PORT}:7687"
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-testpassword}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=256m
      - NEO4J_dbms_memory_heap_max__size=512m
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:${GOFR_NEO4J_HTTP_INTERNAL_PORT_TEST}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    # No volumes - ephemeral
    tmpfs:
      - /data
      - /logs

  chromadb:
    <<: *gofr_ports
    image: gofr-iq-chromadb:latest
    container_name: gofr-iq-chromadb-test
    hostname: gofr-iq-chromadb-test
    restart: "no"
    ports:
      - "${GOFR_CHROMA_PORT}:8000"
    environment:
      - IS_PERSISTENT=FALSE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${GOFR_CHROMA_INTERNAL_PORT_TEST}/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s
    # No volumes - ephemeral
    tmpfs:
      - /chroma/chroma

  # ==========================================================================
  # 1. MCP Server (Core Logic)
  # ==========================================================================
  mcp:
    <<: *gofr_ports
    image: gofr-iq-prod:latest
    container_name: gofr-iq-mcp-test
    hostname: gofr-iq-mcp-test
    restart: "no"
    user: root
    working_dir: /home/gofr-iq
    entrypoint: ["/bin/sh", "-c"]
    depends_on:
      vault:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    command:
      - |
        mkdir -p /home/gofr-iq/data/storage /home/gofr-iq/data/auth
        chown -R gofr-iq:gofr-iq /home/gofr-iq/data
        exec su -s /bin/bash gofr-iq -c '/home/gofr-iq/.venv/bin/python -m app.main_mcp --host 0.0.0.0 --port ${GOFR_IQ_MCP_PORT} --jwt-secret ${GOFR_JWT_SECRET}'
    environment:
      - GOFR_IQ_ENV=TEST
      - GOFR_IQ_MCP_PORT=${GOFR_IQ_MCP_PORT}
      - GOFR_IQ_LOG_LEVEL=${GOFR_IQ_LOG_LEVEL:-DEBUG}
      - GOFR_JWT_SECRET=${GOFR_JWT_SECRET}
      # Auth Backend (Vault - test container, dev mode)
      - GOFR_AUTH_BACKEND=vault
      - GOFR_VAULT_URL=http://gofr-vault-test:8200
      - GOFR_VAULT_TOKEN=${GOFR_VAULT_DEV_TOKEN}
      - VAULT_TOKEN=${GOFR_VAULT_DEV_TOKEN}
      - VAULT_ADDR=http://gofr-vault-test:8200
      - GOFR_VAULT_PATH_PREFIX=gofr-test/auth
      - GOFR_VAULT_MOUNT_POINT=secret
      # Infrastructure connections (test containers)
      - GOFR_IQ_CHROMADB_HOST=gofr-iq-chromadb-test
      - GOFR_IQ_CHROMADB_PORT=8000
      - GOFR_IQ_NEO4J_URI=bolt://gofr-iq-neo4j-test:7687
      - GOFR_IQ_NEO4J_USER=neo4j
      - GOFR_IQ_NEO4J_PASSWORD=${NEO4J_PASSWORD:-testpassword}
      # LLM API key for entity extraction (required for graph index)
      - GOFR_IQ_OPENROUTER_API_KEY=${GOFR_IQ_OPENROUTER_API_KEY}
    ports:
      - "${GOFR_IQ_MCP_PORT}:${GOFR_IQ_MCP_PORT}"
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_IQ_MCP_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s
    # No persistent volumes - ephemeral

  # ==========================================================================
  # 2. MCPO Server (OpenAPI Wrapper)
  # ==========================================================================
  mcpo:
    <<: *gofr_ports
    image: gofr-iq-prod:latest
    container_name: gofr-iq-mcpo-test
    hostname: gofr-iq-mcpo-test
    restart: "no"
    user: gofr-iq
    working_dir: /home/gofr-iq
    entrypoint: []
    depends_on:
      mcp:
        condition: service_healthy
    command: >
      /home/gofr-iq/.venv/bin/mcpo
      --host 0.0.0.0 --port ${GOFR_IQ_MCPO_PORT} --server-type streamable-http
      -- http://gofr-iq-mcp-test:${GOFR_IQ_MCP_PORT}/mcp
    environment:
      - GOFR_IQ_ENV=TEST
      - GOFR_IQ_MCP_PORT=${GOFR_IQ_MCP_PORT}
      - GOFR_IQ_MCPO_PORT=${GOFR_IQ_MCPO_PORT}
    ports:
      - "${GOFR_IQ_MCPO_PORT}:${GOFR_IQ_MCPO_PORT}"
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_IQ_MCPO_PORT}/openapi.json || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ==========================================================================
  # 3. Web Server (Health Check Only)
  # ==========================================================================
  web:
    <<: *gofr_ports
    image: gofr-iq-prod:latest
    container_name: gofr-iq-web-test
    hostname: gofr-iq-web-test
    restart: "no"
    user: gofr-iq
    working_dir: /home/gofr-iq
    entrypoint: []
    command: >
      /home/gofr-iq/.venv/bin/python -m app.main_web
      --host 0.0.0.0 --port ${GOFR_IQ_WEB_PORT}
    environment:
      - GOFR_IQ_ENV=TEST
      - GOFR_IQ_WEB_PORT=${GOFR_IQ_WEB_PORT}
      - GOFR_IQ_LOG_LEVEL=${GOFR_IQ_LOG_LEVEL:-DEBUG}
    ports:
      - "${GOFR_IQ_WEB_PORT}:${GOFR_IQ_WEB_PORT}"
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_IQ_WEB_PORT}/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

# ==========================================================================
# Networks - Test Network (isolated from production)
# ==========================================================================
networks:
  gofr-test-net:
    name: gofr-test-net
    external: true
    # Network is isolated for testing
    # Create manually if needed: docker network create gofr-test-net

# ==========================================================================
# No Volumes - All services use tmpfs for ephemeral storage
# ==========================================================================
