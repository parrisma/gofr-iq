# GOFR-IQ Docker Compose - Complete Production Stack
#
# Port Configuration:
#   All ports defined in lib/gofr-common/config/gofr_ports.env
#   Must be exported to environment before running docker compose
# 
# OpenWebUI Integration:
#   OpenWebUI connects to MCPO which exposes MCP tools as REST endpoints.
#   Configure OpenWebUI to use: http://localhost:${GOFR_IQ_MCPO_PORT}
#
# Usage:
#   Use start-swarm.sh to start production stack (recommended)
#   OR manually:
#     cd docker
#     set -a && source ../lib/gofr-common/config/gofr_ports.env && set +a
#     docker compose up -d
#
# Services:
#   - vault:    HashiCorp Vault (Auth backend) - port ${GOFR_VAULT_PORT}
#   - neo4j:    Graph Database - ports ${GOFR_NEO4J_HTTP_PORT}, ${GOFR_NEO4J_BOLT_PORT}
#   - chromadb: Vector Database - port ${GOFR_CHROMA_PORT}
#   - mcp:      MCP Server (Core Logic) - port ${GOFR_IQ_MCP_PORT}
#   - mcpo:     MCPO Server (OpenAPI for OpenWebUI) - port ${GOFR_IQ_MCPO_PORT}
#   - web:      Web Server (Health Check Only) - port ${GOFR_IQ_WEB_PORT}

name: gofr-iq

services:
  # ==========================================================================
  # INFRASTRUCTURE (Shared)
  # ==========================================================================
  
  # HashiCorp Vault - Auth Backend (Production Mode)
  vault:
    image: gofr-iq-vault:latest
    container_name: gofr-vault
    hostname: gofr-vault
    restart: unless-stopped
    cap_add:
      - IPC_LOCK
    ports:
      - "${GOFR_VAULT_PORT}:${GOFR_VAULT_PORT}"
    volumes:
      - gofr-vault-data:/vault/data
      - gofr-vault-logs:/vault/logs
      - gofr-vault-config:/vault/config
    environment:
      - VAULT_ADDR=http://0.0.0.0:${GOFR_VAULT_PORT}
      - VAULT_API_ADDR=http://0.0.0.0:${GOFR_VAULT_PORT}
      - VAULT_LOG_LEVEL=info
      # For simplified setup, we use VAULT_DEV_ROOT_TOKEN_ID
      # In true production, remove this and use proper init/unseal
      - VAULT_DEV_ROOT_TOKEN_ID=${GOFR_VAULT_DEV_TOKEN}
      - VAULT_DEV_LISTEN_ADDRESS=0.0.0.0:${GOFR_VAULT_PORT}
    networks:
      - gofr-net
    healthcheck:
      test: ["CMD", "vault", "status"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s

  neo4j:
    image: gofr-iq-neo4j:latest
    container_name: gofr-neo4j
    hostname: gofr-neo4j
    restart: unless-stopped
    ports:
      - "${GOFR_NEO4J_HTTP_PORT}:7474"
      - "${GOFR_NEO4J_BOLT_PORT}:7687"
    volumes:
      - gofr-iq-neo4j-data:/data
      - gofr-iq-neo4j-logs:/logs
    environment:
      - NEO4J_AUTH=neo4j/${NEO4J_PASSWORD:-gofr-dev-password}
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      - NEO4J_dbms_memory_heap_initial__size=512m
      - NEO4J_dbms_memory_heap_max__size=1G
    networks:
      - gofr-net
    healthcheck:
      test: ["CMD", "wget", "-q", "--spider", "http://localhost:${GOFR_NEO4J_HTTP_INTERNAL_PORT}"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s

  chromadb:
    image: gofr-iq-chromadb:latest
    container_name: gofr-chromadb
    hostname: gofr-chromadb
    restart: unless-stopped
    ports:
      - "${GOFR_CHROMA_PORT}:8000"
    volumes:
      - gofr-iq-chroma-data:/chroma/chroma
    environment:
      - IS_PERSISTENT=TRUE
      - PERSIST_DIRECTORY=/chroma/chroma
      - ANONYMIZED_TELEMETRY=FALSE
    networks:
      - gofr-net
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:${GOFR_CHROMA_INTERNAL_PORT}/api/v1/heartbeat"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 20s

  # ==========================================================================
  # 1. MCP Server (Core Logic)
  # ==========================================================================
  mcp:
    image: gofr-iq-prod:latest
    container_name: gofr-iq-mcp
    hostname: gofr-iq-mcp
    restart: unless-stopped
    user: gofr-iq
    working_dir: /home/gofr-iq
    entrypoint: []
    depends_on:
      vault:
        condition: service_healthy
      neo4j:
        condition: service_healthy
      chromadb:
        condition: service_healthy
    command: >
      /home/gofr-iq/.venv/bin/python -m app.main_mcp
      --host 0.0.0.0 --port ${GOFR_IQ_MCP_PORT}
    environment:
      - GOFR_IQ_ENV=PROD
      - GOFR_IQ_MCP_PORT=${GOFR_IQ_MCP_PORT}
      - GOFR_IQ_LOG_LEVEL=${GOFR_IQ_LOG_LEVEL:-INFO}
      - GOFR_IQ_AUTH_DISABLED=false
      # JWT Secret for token signing/verification (shared across services)
      - GOFR_IQ_JWT_SECRET=${GOFR_JWT_SECRET}
      - GOFR_JWT_SECRET=${GOFR_JWT_SECRET}
      # Auth Backend (Vault) - shared across all GOFR services
      - GOFR_AUTH_BACKEND=vault
      - GOFR_VAULT_URL=http://gofr-vault:${GOFR_VAULT_PORT}
      - GOFR_VAULT_TOKEN=${GOFR_VAULT_DEV_TOKEN}
      - GOFR_VAULT_PATH_PREFIX=gofr/auth
      - GOFR_VAULT_MOUNT_POINT=secret
      # Infrastructure connections
      - GOFR_IQ_CHROMADB_HOST=gofr-chromadb
      - GOFR_IQ_CHROMADB_PORT=${GOFR_CHROMA_INTERNAL_PORT}
      - GOFR_IQ_NEO4J_URI=bolt://gofr-neo4j:${GOFR_NEO4J_BOLT_INTERNAL_PORT}
      - GOFR_IQ_NEO4J_USER=neo4j
      - GOFR_IQ_NEO4J_PASSWORD=${NEO4J_PASSWORD:-gofr-dev-password}
      # LLM Configuration
      - GOFR_IQ_OPENROUTER_API_KEY=${GOFR_IQ_OPENROUTER_API_KEY:-}
      - GOFR_IQ_OPENROUTER_BASE_URL=${GOFR_IQ_OPENROUTER_BASE_URL:-https://openrouter.ai/api/v1}
      - GOFR_IQ_LLM_MODEL=${GOFR_IQ_LLM_MODEL:-anthropic/claude-opus-4}
      - GOFR_IQ_EMBEDDING_MODEL=${GOFR_IQ_EMBEDDING_MODEL:-qwen/qwen3-embedding-8b}
      - GOFR_IQ_LLM_TIMEOUT=${GOFR_IQ_LLM_TIMEOUT:-60}
      - GOFR_IQ_LLM_MAX_RETRIES=${GOFR_IQ_LLM_MAX_RETRIES:-3}
    ports:
      - "${GOFR_IQ_MCP_PORT}:${GOFR_IQ_MCP_PORT}"
    volumes:
      - gofr-iq-data:/home/gofr-iq/data
    networks:
      - gofr-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_IQ_MCP_PORT}/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ==========================================================================
  # 2. MCPO Server (OpenAPI Wrapper)
  # ==========================================================================
  mcpo:
    image: gofr-iq-prod:latest
    container_name: gofr-iq-mcpo
    hostname: gofr-iq-mcpo
    restart: unless-stopped
    user: gofr-iq
    working_dir: /home/gofr-iq
    entrypoint: []
    depends_on:
      mcp:
        condition: service_healthy
    command: >
      /home/gofr-iq/.venv/bin/mcpo
      --host 0.0.0.0 --port ${GOFR_IQ_MCPO_PORT} --server-type streamable-http
      -- http://gofr-iq-mcp:${GOFR_IQ_MCP_PORT}/mcp
    environment:
      - GOFR_IQ_ENV=PROD
      - GOFR_IQ_MCP_PORT=${GOFR_IQ_MCP_PORT}
      - GOFR_IQ_MCPO_PORT=${GOFR_IQ_MCPO_PORT}
    ports:
      - "${GOFR_IQ_MCPO_PORT}:${GOFR_IQ_MCPO_PORT}"
    networks:
      - gofr-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_IQ_MCPO_PORT}/openapi.json || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 15s

  # ==========================================================================
  # 3. Web Server (Health Check Only)
  # ==========================================================================
  web:
    image: gofr-iq-prod:latest
    container_name: gofr-iq-web
    hostname: gofr-iq-web
    restart: unless-stopped
    user: gofr-iq
    working_dir: /home/gofr-iq
    entrypoint: []
    command: >
      /home/gofr-iq/.venv/bin/python -m app.main_web
      --host 0.0.0.0 --port ${GOFR_IQ_WEB_PORT}
    environment:
      - GOFR_IQ_ENV=PROD
      - GOFR_IQ_WEB_PORT=${GOFR_IQ_WEB_PORT}
      - GOFR_IQ_LOG_LEVEL=${GOFR_IQ_LOG_LEVEL:-INFO}
    ports:
      - "${GOFR_IQ_WEB_PORT}:${GOFR_IQ_WEB_PORT}"
    networks:
      - gofr-net
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:${GOFR_IQ_WEB_PORT}/health || exit 1"]
      interval: 15s
      timeout: 5s
      retries: 3
      start_period: 10s

# ==========================================================================
# Networks
# ==========================================================================
networks:
  gofr-net:
    name: gofr-net
    external: true
    # Network is shared across dev container, infra scripts, and compose
    # Create manually if needed: docker network create gofr-net

# ==========================================================================
# Volumes - Persistent
# ==========================================================================
volumes:
  gofr-vault-data:
    name: gofr-vault-data
    external: false
  gofr-vault-logs:
    name: gofr-vault-logs
    external: false
  gofr-vault-config:
    name: gofr-vault-config
    external: false
  gofr-iq-neo4j-data:
    name: gofr-iq-neo4j-data
    external: false
  gofr-iq-neo4j-logs:
    name: gofr-iq-neo4j-logs
    external: false
  gofr-iq-chroma-data:
    name: gofr-iq-chroma-data
    external: false
  gofr-iq-data:
    name: gofr-iq-data
    external: false
  gofr-iq-backups:
    name: gofr-iq-backups
    external: false
  gofr-iq-prod-logs:
    name: gofr-iq-prod-logs