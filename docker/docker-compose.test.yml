# GOFR-IQ Docker Compose - Test Stack (Ephemeral)
# 
# Usage:
#   docker compose -f docker-compose.test.yml up -d     # Start test services
#   docker compose -f docker-compose.test.yml down -v   # Stop and cleanup
#
# Key Differences from dev stack:
#   - Uses ephemeral tmpfs volumes (fast, no persistence)
#   - Isolated network (gofr-test-net)
#   - Different container names to avoid conflicts
#   - Relaxed security for testing
#   - Faster startup with smaller memory footprint

name: gofr-iq-test

services:
  # ==========================================================================
  # ChromaDB - Test Instance (Ephemeral)
  # ==========================================================================
  chromadb-test:
    image: gofr-iq-chromadb:latest
    build:
      context: .
      dockerfile: Dockerfile.chromadb
    container_name: gofr-iq-chromadb-test
    hostname: gofr-iq-chromadb-test
    environment:
      - IS_PERSISTENT=FALSE
      - ANONYMIZED_TELEMETRY=FALSE
      - ALLOW_RESET=TRUE
    ports:
      - "${GOFRIQ_TEST_CHROMADB_PORT:-8101}:8000"
    tmpfs:
      - /chroma/chroma:size=512M
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD", "bash", "-c", "exec 3<>/dev/tcp/localhost/8000 && echo -e 'GET /api/v2/heartbeat HTTP/1.0\r\nHost: localhost\r\n\r\n' >&3 && head -1 <&3 | grep -q '200 OK'"]
      interval: 5s
      timeout: 3s
      retries: 3
      start_period: 10s

  # ==========================================================================
  # Neo4j - Test Instance (Ephemeral)
  # ==========================================================================
  neo4j-test:
    image: gofr-iq-neo4j:latest
    build:
      context: .
      dockerfile: Dockerfile.neo4j
    container_name: gofr-iq-neo4j-test
    hostname: gofr-iq-neo4j-test
    environment:
      - NEO4J_AUTH=neo4j/testpassword
      - NEO4J_PLUGINS=["apoc"]
      - NEO4J_apoc_export_file_enabled=true
      - NEO4J_apoc_import_file_enabled=true
      - NEO4J_apoc_import_file_use__neo4j__config=true
      - NEO4J_dbms_security_procedures_unrestricted=apoc.*
      # Smaller memory for test instances
      - NEO4J_dbms_memory_heap_initial__size=256m
      - NEO4J_dbms_memory_heap_max__size=512m
      # Disable some features for faster startup
      - NEO4J_dbms_tx__log_rotation_retention__policy=1 files
    ports:
      - "${GOFRIQ_TEST_NEO4J_HTTP_PORT:-7475}:7474"
      - "${GOFRIQ_TEST_NEO4J_BOLT_PORT:-7688}:7687"
    tmpfs:
      - /data:size=512M
      - /logs:size=64M
    networks:
      - gofr-test-net
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:7474"]
      interval: 5s
      timeout: 3s
      retries: 5
      start_period: 30s

# ==========================================================================
# Networks - Isolated test network
# ==========================================================================
networks:
  gofr-test-net:
    name: gofr-test-net
    driver: bridge
