# Investment Policy Statement (IPS) Architecture

## Overview

Investment Policy Statements (IPS) are treated as **external documents** managed by upstream business systems (sales, trading, compliance). They are **supplied at query time** as JSON parameters rather than stored in the GOFR-IQ graph.

## Architecture Decision

**Decision**: IPS lives outside the graph, managed by business systems

**Rationale**:
1. **Separation of Concerns**: GOFR-IQ focuses on intelligence (filtering, ranking, analysis), not policy management
2. **Upstream Ownership**: Sales/trading systems own the IPS lifecycle (versioning, approvals, audit trails)
3. **Regulatory Compliance**: Compliance systems handle regulatory requirements, attestations, board resolutions
4. **Simplicity**: Avoid schema complexity for storing and versioning policy documents in graph

## Data Flow

```
┌─────────────────────────────────────┐
│ Upstream Systems                    │
│ • Salesforce (client onboarding)    │
│ • Compliance DB (policy approvals)  │
│ • Aladdin/PMS (portfolio mandates)  │
│ • ESG Data Providers                │
└─────────────┬───────────────────────┘
              │ IPS JSON
              ▼
┌─────────────────────────────────────┐
│ GOFR-IQ Feed Query                  │
│ get_client_feed(                    │
│   client_guid="client-xyz",         │
│   ips_json={...}                    │
│ )                                   │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│ ClientProfiler                      │
│ • Parse IPS JSON                    │
│ • Apply filters (trust, ESG, sector)│
│ • Rerank by theme alignment         │
└─────────────┬───────────────────────┘
              │
              ▼
┌─────────────────────────────────────┐
│ Filtered & Ranked Feed Results      │
└─────────────────────────────────────┘
```

## IPS Structure

```json
{
  "client_guid": "client-hedge-fund",
  "client_name": "Quantum Momentum Partners",
  "archetype": "Hedge Fund",
  
  "primary_objective": "Generate absolute returns...",
  "risk_tolerance": "High - willing to accept volatility",
  "time_horizon": "Short to medium (3-24 months)",
  
  "trust_requirement": "Accept medium-trust sources (trust level 2+)",
  "prohibited_sectors": ["Tobacco", "Controversial weapons"],
  "esg_exclusions": ["Severe ESG controversies", "Thermal coal"],
  "positive_themes": ["Technology disruption", "Healthcare innovation"],
  "news_priority": ["M&A Activity", "Earnings Surprises"],
  
  "alert_threshold": "medium-high",
  "regulatory_framework": "SEC registered investment advisor",
  "reporting_requirements": "Monthly performance reports"
}
```

## Production Sources

In production, IPS data would be sourced from:

1. **Client Onboarding**: Questionnaires, risk tolerance assessments
2. **Investment Committee**: Board resolutions, mandate documents
3. **Compliance Systems**: Regulatory restrictions, prohibited lists
4. **Portfolio Management Systems**: Position limits, concentration rules
5. **ESG Data Providers**: Exclusion lists, controversy ratings
6. **Third-Party Services**: MSCI ESG, Sustainalytics, RepRisk

## Simulation Mode

For simulation/testing, IPS documents are stored in:
- `simulation/client_ips/ips_{client_guid}.json`
- Generated by `simulation/generate_client_ips.py`

The `ClientProfiler` supports dual-mode operation:
```python
# Production: IPS supplied at query time
profile = profiler.get_profile("client-xyz", ips_json={...})

# Simulation: IPS loaded from files
profile = profiler.get_profile("client-hedge-fund")
```

## Benefits

### For Business Systems
- ✅ Retain ownership of client policy data
- ✅ Manage versioning, audit trails, approvals
- ✅ Handle regulatory compliance requirements
- ✅ Control data access and security

### For GOFR-IQ
- ✅ Focus on intelligence value-add (filtering, ranking)
- ✅ Avoid complex policy schema in graph
- ✅ Clean API: just accept IPS JSON parameter
- ✅ Easier testing with mock IPS documents

### For Clients
- ✅ Policy changes take effect immediately (no graph update lag)
- ✅ Single source of truth in business systems
- ✅ Transparency: can audit IPS used for each query
- ✅ Consistency across all financial systems

## Implementation

### Query Interface
```python
from app.services.feed_service import get_client_feed

# Client query with IPS
feed_results = await get_client_feed(
    client_guid="client-abc123",
    portfolio_guid="portfolio-xyz789",
    ips_json={
        "trust_requirement": "Accept sources trust level 6+",
        "prohibited_sectors": ["Tobacco", "Firearms"],
        "esg_exclusions": ["Thermal coal", "Controversial weapons"],
        "positive_themes": ["Clean energy", "Healthcare innovation"]
    }
)
```

### Filtering Logic
```python
from simulation.client_profiler import ClientProfiler

profiler = ClientProfiler()

# Apply IPS filters
filtered = profiler.apply_filters(
    client_guid="client-xyz",
    documents=raw_results,
    ips_json=ips_data
)

# Rerank by IPS preferences
reranked = profiler.rerank_documents(
    client_guid="client-xyz",
    documents=filtered,
    ips_json=ips_data
)
```

## Testing

### Demo Script
```bash
python simulation/demo_ips_filtering.py
```

Shows how same feed produces different results for:
- **Hedge Fund** (min_trust=2): Aggressive, accepts 8/8 documents
- **Pension Fund** (min_trust=8): Conservative, filters to 3/8 documents (62% filtered)
- **Retail** (min_trust=1): Permissive, accepts 8/8 documents

### Validation Results

| Client Type | Min Trust | Original Docs | Filtered Docs | Filter Rate |
|-------------|-----------|---------------|---------------|-------------|
| Hedge Fund | 2 | 8 | 8 | 0% |
| Pension Fund | 8 | 8 | 3 | 62% |
| Retail | 1 | 8 | 8 | 0% |

Demonstrates IPS-based personalization:
- ✅ Trust gating works (pension fund excludes trust <8)
- ✅ Same raw feed, different results per client
- ✅ No false positives (all filters apply correctly)

## Future Enhancements

### Phase 5.3: Query Translation
- Natural language to Cypher conversion
- "Show me ESG risks in my portfolio" → Cypher query

### Phase 5.4: LLM Reranker
- GPT-4 reranking with full IPS context
- Theme alignment scoring with semantic similarity
- Event priority boosting based on news preferences

### Phase 5.5: Entity Resolution
- Alias matching (OMNI vs OmniCorp)
- Obfuscated reference detection
- Multi-language entity normalization

## References

- IPS Generator: [simulation/generate_client_ips.py](../../simulation/generate_client_ips.py)
- ClientProfiler: [simulation/client_profiler.py](../../simulation/client_profiler.py)
- Demo Script: [simulation/demo_ips_filtering.py](../../simulation/demo_ips_filtering.py)
- Sample IPS: [simulation/client_ips/](../../simulation/client_ips/)
- Enhancement Plan: [simulation/simulation_enhancement_plan.md](../../simulation/simulation_enhancement_plan.md)
