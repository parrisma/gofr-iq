# Development Conventions

This is to be read periodically by LLM Agents so as their context window fades it helps keep them on track for development style and agent commands . **Read before making changes.**

## Core Principles

1. **Use scripts, not hand edits** — Existing scripts are authoritative
2. **Vault/ports are SSOT** — No local .env fallbacks; secrets from Vault or gofr_ports.env only
3. **Fail fast** — Missing secrets/tokens/health → immediate abort
4. **Prove artifacts** — Verify counts after each stage (groups, tokens, sources, nodes, docs, embeddings)
5. **See also** — [single-source-of-truth-remediation.md](../architecture/single-source-of-truth-remediation.md), [simulation_ssot_plan.md](../../simulation/simulation_ssot_plan.md)

## Quick Reference

### Environment
```bash
./scripts/start-prod.sh          # normal start
./scripts/start-prod.sh --fresh  # init fresh Vault
./scripts/start-prod.sh --reset  # nuke & pave (⚠️ destroys all data)
./docker/manage-infra.sh status # health check
```

**bootstrap.py writes to docker/.env**: `GOFR_JWT_SECRET`, `VAULT_ROOT_TOKEN`, `NEO4J_PASSWORD`, `GOFR_IQ_OPENROUTER_API_KEY`

### Testing
```bash
./scripts/run_tests.sh --mode unit|integration|all
./scripts/run_tests.sh --refresh-env    # fix 401/403 errors
./scripts/run_tests.sh --stop           # fix port conflicts
./scripts/run_tests.sh --cleanup-only   # remove stale containers
```

**Architecture**: Vault-generated env, ports = prod+100, network = gofr-test-net

### Simulation
```bash
./simulation/run_simulation.sh --count 50              # full pipeline (sources env automatically)
./simulation/run_simulation.sh --init-groups-only      # initialize groups only
./simulation/run_simulation.sh --skip-universe         # skip universe load

# For individual simulation scripts, use the SSOT sourcing pattern:
# Source the authoritative config files (docker/.env now contains derived infrastructure vars)
set -a
source lib/gofr-common/config/gofr_ports.env
source docker/.env
set +a
export VAULT_TOKEN=$(cat secrets/vault_root_token)

# Run your script
uv run python simulation/load_universe_to_neo4j.py
uv run python simulation/load_clients_to_neo4j.py
```

**Rules**: Vault-derived secrets only, health-check first, stage-gate validation, fail loudly on auth errors

**SSOT Environment Pattern**: 
- **`docker/.env`**: Generated by `scripts/bootstrap.py`. Authoritative for `NEO4J_PASSWORD`, and derived vars like `GOFR_IQ_NEO4J_URI`.
- **`secrets/vault_root_token`**: Generated by `scripts/bootstrap.py`. Authoritative for `VAULT_TOKEN` (Zero-Trust Bootstrap).
- **`secrets/service_creds/`**: AppRole credentials per service.
- **`lib/gofr-common/config/gofr_ports.env`**: Authoritative for all ports.

**Do NOT** hand-edit `docker/.env` or create local `.env` files.
**Do NOT** hardcode secrets in scripts. Source them from the SSOT files.
**Do NOT** manual export `GOFR_IQ_NEO4J_*` variables; fix `scripts/bootstrap.py` if they are missing.

### Scripts
- **Sources**: `./scripts/manage_source.sh list|create --docker`
- **Docs**: `./scripts/manage_document.sh ingest --docker ...`
- **Bootstrap**: `uv run scripts/bootstrap.py`

## Critical Don'ts

| ❌ Don't | ✅ Do |
|----------|-------|
| Pass VAULT_ADDR/VAULT_TOKEN manually | Let dev container environment provide them |
| Write synthetic docs by hand | Use `generate_synthetic_stories.py` |
| Hardcode API keys or use fallback secrets | Source from Vault/docker/.env only |
| Use localhost inside containers | Use service hostnames (gofr-vault, gofr-neo4j) |
| Drop ad-hoc .env files in app/test | Use docker/.env (SSOT) |
| Start services without start-prod.sh | Vault won't be initialized |
| Pipe long commands to head/tail/tee | Shows nothing to user during execution (see below) |

## Command Output Best Practices

**Default: Stream to terminal** — Let users see real-time progress for long operations (simulations, builds, ingestion)

- ✅ **Use redirects only when**: Capturing output for programmatic parsing
- ❌ **Never for**: Multi-stage operations where users need visibility

```bash
# ❌ BAD - hides progress
./simulation/run_simulation.sh --count 50 2>&1 | tee /tmp/sim.log

# ✅ GOOD - shows real-time output
./simulation/run_simulation.sh --count 50
```

## File Locations (SSOT)

| Path | Contents |
|------|----------|
| **`docker/.env`** | **SSOT: `GOFR_JWT_SECRET`, `NEO4J_PASSWORD`, `GOFR_IQ_OPENROUTER_API_KEY`** |
| `secrets/vault_root_token` | `VAULT_TOKEN` (Zero-Trust Bootstrap) |
| `secrets/vault_unseal_key` | `VAULT_UNSEAL_KEY` |
| `secrets/service_creds/` | AppRole credentials per service |
| `config/generated/bootstrap_tokens.json` | **Admin/public JWT tokens (`admin_token`, `public_token`)** |
| `lib/gofr-common/config/gofr_ports.env` | All service ports |
| **`lib/gofr-common/src/gofr_common/gofr_env.py`** | **SSOT Python module — ALL scripts import this** |

**Networks**: Prod/dev = gofr-net @ gofr-vault:8201 | Test = gofr-test-net @ gofr-vault:8301 (ports+100)

## Python Script Token Loading (SSOT)

### ⚠️ MANDATORY: Use the SSOT Module

**ALL Python scripts that need JWT tokens MUST import from `gofr_common.gofr_env`:**

```python
# Add workspace to path if needed (for scripts outside app/)
import sys
from pathlib import Path
PROJECT_ROOT = Path(__file__).resolve().parent.parent  # adjust depth as needed
sys.path.insert(0, str(PROJECT_ROOT))
sys.path.insert(0, str(PROJECT_ROOT / "lib" / "gofr-common" / "src"))

# THE ONLY WAY TO GET TOKENS:
from gofr_common.gofr_env import (
    get_admin_token,      # For admin ops (source create, group manage)
    get_public_token,     # For public read-only ops
    get_token_for_group,  # Maps group names → appropriate token
    get_workspace_root,   # Resolve paths
)

# Usage examples:
admin_token = get_admin_token()
public_token = get_public_token()

# For group-based ingestion (handles "admin", "group-simulation", "public"):
group = story.get("upload_as_group")
token = get_token_for_group(group)  # Automatic mapping!
```

### Token Key Names (Reference Only)

The SSOT module handles this, but for reference:
- **`admin_token`** — Full admin access (NOT `admin`)
- **`public_token`** — Read-only access (NOT `public`)

### ❌ DO NOT:
- Manually load `bootstrap_tokens.json` — use the module
- Look for keys named `admin` or `public` — they don't exist
- Create new token loading functions — use the module
- Query Vault directly — use the pre-generated file via the module
- Hardcode tokens or paths — use the module

### Verify SSOT Module Works:
```bash
uv run python -c "from gofr_common.gofr_env import get_admin_token; print(get_admin_token()[:20])"
```


## Simulation Enhancement Pattern

1. **Generate** → Modify `universe/builder.py`, `generate_synthetic_stories.py`, add validation metadata
2. **Reset** → `./docker/start-prod.sh --reset`, reload universe/clients, generate/ingest docs
3. **Query** → Build/test against enhanced corpus only (never old/incomplete data)
4. **Validate** → Use validation_metadata for closed-loop testing

